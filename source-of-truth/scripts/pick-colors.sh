#!/bin/bash
set -euo pipefail

# pick-colors.sh
# - Picks a random wallpaper.
# - Extracts a distinct color palette from it (requires ImageMagick).
# - Generates a Waybar style.css, qt6ct color scheme, and Hyprland color config.
# - Applies the theme.

# --- Configuration ---
WALLPAPER_DIR="${HOME}/.config/source-of-truth/wallpapers"
OUT_DIR="${HOME}/.config/source-of-truth"
WAYBAR_CSS_DIR="${HOME}/.config/waybar"
QT6CT_DIR="${HOME}/.config/qt6ct/colors"
HYPRLAND_DIR="${HOME}/.config/hypr"

# --- Helper Functions ---
hex_to_rgb() {
    local hex=${1#"#"}
    printf "%d,%d,%d" "0x${hex:0:2}" "0x${hex:2:2}" "0x${hex:4:2}"
}

get_brightness() {
    local hex=${1#"#"}
    local r=$((16#${hex:0:2}))
    local g=$((16#${hex:2:2}))
    local b=$((16#${hex:4:2}))
    echo $(( (299*r + 587*g + 114*b) / 1000 ))
}


# --- Main Script ---
mkdir -p "$OUT_DIR" "$WAYBAR_CSS_DIR" "$QT6CT_DIR" "$HYPRLAND_DIR"

# 1. Select a random wallpaper
WALLPAPER=$(find "$WALLPAPER_DIR" -type f \( -iname '*.jpg' -o -iname '*.png' \) -print0 | shuf -z -n1 | tr -d '\0')
if [[ -z "$WALLPAPER" ]]; then
    echo "Warning: No wallpapers found in $WALLPAPER_DIR. Using default colors." >&2
    WALLPAPER=""
fi

# 2. Extract a palette of distinct colors
if [[ -n "$WALLPAPER" ]] && command -v magick >/dev/null 2>&1; then
    palette_raw=$(magick "$WALLPAPER" +dither -colors 8 -unique-colors -scale 100x100\! txt:- | grep -oP '#[0-9a-fA-F]{6}' | awk '!seen[$0]++')
    palette=($palette_raw)
else
    palette=("#282a36" "#f8f8f2" "#50fa7b" "#ffb86c" "#ff79c6" "#bd93f9" "#8be9fd" "#ff5555")
fi


# Ensure we have enough colors, otherwise fallback to a default palette
if ((${#palette[@]} < 4)); then
    echo "Warning: Could not extract a diverse enough palette. Using defaults." >&2
    palette=("#282a36" "#f8f8f2" "#50fa7b" "#ffb86c" "#ff79c6" "#bd93f9" "#8be9fd" "#ff5555")
fi

# 3. Assign distinct colors for the theme
BG="${palette[0]}"
ACCENT1="${palette[1]}"
ACCENT2="${palette[3]}" # Use a different accent
URGENT="${palette[4]}"

# Find the brightest color in the palette for the foreground text
FG="${palette[1]}" # Default to the second color
max_brightness=0
for color in "${palette[@]}"; do
    brightness=$(get_brightness "$color")
    if (( brightness > max_brightness )); then
        max_brightness=$brightness
        FG=$color
    fi
done

# Helper function to find a good contrasting foreground color
find_contrast_fg() {
    local bg_hex=${1#"#"}
    local r_bg=$((16#${bg_hex:0:2}))
    local g_bg=$((16#${bg_hex:2:2}))
    local b_bg=$((16#${bg_hex:4:2}))
    local lum_bg=$(( (299*r_bg + 587*g_bg + 114*b_bg) / 1000 ))

    if (( lum_bg > 128 )); then
        echo "#000000"
    else
        echo "#ffffff"
    fi
}

FOCUSED_FG=$(find_contrast_fg "$ACCENT1")


# Convert main colors to RGB for rgba() CSS function
ACCENT2_RGB=$(hex_to_rgb "$ACCENT2")

# 4. Generate the Waybar style.css
cat > "${WAYBAR_CSS_DIR}/style.css" << EOF
/* Generated by pick-colors.sh */

* {
    border: none;
    border-radius: 0;
    font-family: JetBrains Mono, monospace;
    font-size: 14px;
    min-height: 0;
}

window#waybar {
    background-color: transparent;
    color: ${FG};
}

#workspaces button {
    padding: 0 5px;
    background-color: transparent;
    color: ${FG};
    border-radius: 8px;
}

#workspaces button:hover {
    background: rgba(0, 0, 0, 0.2);
}

#workspaces button.focused {
    background-color: ${ACCENT1};
    color: ${FOCUSED_FG};
}

#workspaces button.urgent {
    background-color: ${URGENT};
}

.module {
    padding: 0 10px;
    margin: 0 4px;
    background-color: rgba(${ACCENT2_RGB}, 0.5); /* Semi-transparent accent */
    border-radius: 8px;
}

#clock, #battery, #pulseaudio, #network, #custom-wp-button {
    padding: 0 10px;
}
EOF

# 5. Generate the qt6ct color scheme
cat > "${QT6CT_DIR}/GeneratedTheme.conf" << EOF
[General]
background=${BG}
foreground=${FG}
base=${BG}
text=${FG}
button=${ACCENT2}
button_text=${FOCUSED_FG}
highlight=${ACCENT1}
highlight_text=${FOCUSED_FG}
link=${ACCENT1}
link_visited=${ACCENT1}
[Palette]
active_window=${ACCENT2}
inactive_window=${BG}
active_highlight=${ACCENT1}
inactive_highlight=${ACCENT2}
EOF

# 6. Generate the Hyprland color scheme
cat > "${HYPRLAND_DIR}/colors.conf" << EOF
# Generated by pick-colors.sh
\$active_border = rgba(${ACCENT1#"#"}ff)
\$inactive_border = rgba(${ACCENT2#"#"}ff)
general {
    col.active_border = \$active_border
    col.inactive_border = \$inactive_border
}
EOF


# 7. Apply the theme
if [[ -n "$WALLPAPER" ]] && command -v swww >/dev/null 2>&1; then
    swww img "$WALLPAPER" --transition-type any
fi
if command -v systemctl >/dev/null 2>&1; then
    systemctl --user restart waybar.service
fi
if command -v hyprctl >/dev/null 2>&1; then
    hyprctl reload
fi

echo "Theme updated successfully!"
echo "Wallpaper: $WALLPAPER"
echo "BG: $BG, FG: $FG, ACCENT1: $ACCENT1, ACCENT2: $ACCENT2"
